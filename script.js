// --- SELURUH JAVASCRIPT TETAP SAMA DAN BERFUNGSI SEPERTI SEMULA ---
const products = [
{"id":"PGL-2025-2810","category":"agriculture","type":"promo","seller":{"name":"GINA LESTARI","link":"https://anekamarket.my.id/ginalestari","locationLink":"https://www.google.com/maps?q=-7.7838778,113.9015791"},"badge":{"text":"Jasa Profesional","type":"service"},"mainImage":"https://i.imgur.com/Hce5tBB.jpeg","title":"JUAL BIBIT TANAMAN MANGROVE","code":"PGL-2025-2810","price":0,"originalPrice":null,"discount":"Nego","priceVariations":[],"units":["500","1000","5000","10000"],"defaultUnit":"Bibit","details":{"description":"<b>üå± Penjualan & Pemesanan Bibit Mangrove oleh POKMASWAS GINA LESTARI</b><br>\n<strong>POKMASWAS GINA LESTARI</strong> adalah kelompok masyarakat pengawas lingkungan pesisir yang berkomitmen terhadap pelestarian ekosistem mangrove di wilayah pesisir Indonesia. Kami menyediakan bibit mangrove berkualitas untuk berbagai kebutuhan rehabilitasi, konservasi, edukasi, dan kegiatan CSR perusahaan.<br>\n\n<b>üíº Layanan Kami:</b>\n- Penjualan Bibit Mangrove \n- Pemesanan dalam jumlah kecil maupun besar untuk proyek lingkungan, sekolah, komunitas, dan instansi pemerintah.\n- Konsultasi teknis terkait penanaman dan perawatan mangrove.\n- Pengiriman ke seluruh Indonesia dengan sistem pengemasan yang aman dan ramah lingkungan.<br>\n\n<b>üåø Keunggulan Bibit Kami:</b>\n- Bibit hasil pembibitan langsung oleh masyarakat pesisir yang berpengalaman.\n- Tingkat kelangsungan hidup tinggi dan siap tanam.\n- Mendukung pemberdayaan lokal dan pelestarian ekosistem.<br>\n\n<b>ü§ù Dukung Konservasi, Dukung Masyarakat Pesisir</b>\nSetiap pembelian bibit mangrove dari POKMASWAS GINA LESTARI adalah kontribusi nyata dalam menjaga lingkungan dan memberdayakan masyarakat lokal. Mari bersama-sama hijaukan pesisir Indonesia!","images":["https://i.imgur.com/Hce5tBB.jpeg","https://i.imgur.com/vQfvpnB.jpeg","https://i.imgur.com/vrEqgUA.jpeg","https://i.imgur.com/ypktNpj.jpeg","https://i.imgur.com/xqqKQUW.jpeg","https://i.imgur.com/reCWntZ.jpeg","https://i.imgur.com/hkMUsUr.jpeg"],"specs":[{"label":"Kode Produk","value":"PGL-2025-2810"},{"label":"Nama","value":"Moh Misnadi"},{"label":"Alamat","value":"Kp. Pasarean RT.001/RW.003 Desa Peleyan Kecamatan Panarukan"},{"label":"POKMASWAS","value":"GINA LESTARI"},{"label":"Area Layanan","value":"Situbondo & sekitarnya (Nego)"},{"label":"Catatan","value":"Hubungi langsung untuk diskusi harga dan jadwal."},{"label":"email","value":"hasanhahoo@gmail.com"}]},"contact":{"whatsapp":"6285257793638","phone":"+6285257793638"}},
    
{"id":"AWF-2025-2575","category":"livestock","type":"promo","seller":{"name":"Ardiwillis Farm","link":"https://www.anekamarket.my.id/ardiwillisfarm","locationLink":null},"badge":{"text":"Promosi","type":"promo"},"mainImage":"https://i.imgur.com/pKLE9EY.jpeg","title":"Paket Lengkap Ternak Ayam Ardiwilis","code":"AWF-2025-2575","price":8000,"originalPrice":10000,"discount":"10%","priceVariations":[{"name":"Ecer (per ekor)","price":8000},{"name":"10 ekor","price":75000},{"name":"100 ekor","price":700000}],"units":["pcs","kg","biji","ekor"],"defaultUnit":"ekor","details":{"description":"<br>Ardiwillis Farm menyediakan produk unggulan peternakan ayam berkualitas tinggi. Kami menyediakan telur tetas fertil dengan daya tetas tinggi, DOC (Day Old Chicken) berbagai strain unggul, ayam karkas segar, dan ayam bakar siap saji dengan bumbu khas. Semua produk dihasilkan dari peternakan yang dikelola secara profesional dengan standar kesehatan dan kebersihan tinggi. (Note: Harga tersebut bukan harga tetap, & bisa berubah)","images":["https://i.imgur.com/pAygjAZ.jpeg","https://i.imgur.com/XRMPBhw.jpeg","https://i.imgur.com/K5m75Rq.jpeg","https://i.imgur.com/coJadaj.jpeg"],"specs":[{"label":"Kode Produk","value":"AWF-2025-2575"},{"label":"Gerai","value":"Ardiwillis Farm"},{"label":"Jenis","value":"Ayam Pedaging"},{"label":"Usia","value":"DOC (1 hari)"},{"label":"Strain","value":"Cobb 500"},{"label":"Garansi","value":"Hidup sampai diterima"},{"label":"Minimal Order","value":"10 ekor"},{"label":"Catatan","value":"Harga bisa berubah sewaktu-waktu"}]},"contact":{"whatsapp":"6285258544543","phone":"+6285258544543"}},

{"id":"NS-2025-3348","category":"food","type":"promo","seller":{"name":"nikisae","link":"https://www.anekamarket.my.id/nikisae","locationLink":null},"badge":{"text":"Promo Spesial","type":"promo"},"mainImage":"https://i.imgur.com/y8r14Z3.jpeg","title":"Promo Frozen Food Homemade nikisae Sae","code":"NS-2025-3348","price":12000,"originalPrice":15000,"discount":"20% OFF","priceVariations":[{"name":"Pempek","price":12000},{"name":"Tahu Walik","price":11000},{"name":"Nugget Ikan/Ayam","price":12000},{"name":"Dragon Stick","price":12000},{"name":"Otak-Otak Ikan","price":12000}],"units":["pcs","pack","set","lusin"],"defaultUnit":"pcs","details":{"description":"<br><strong>PROMO SPESIAL!</strong> nikisae Sae dari Dapur Yunna menghadirkan promo frozen food homemade dengan kualitas terbaik. Semua produk dibuat dengan bahan pilihan dan teknik khusus untuk menjamin cita rasa autentik. Produk kami termasuk Pempek, Tahu Walik, Otak-Otak Ikan, Nugget Ikan dan Ayam, serta Dragon Stick. Setiap produk dibuat dengan standar kebersihan tinggi dan rasa yang konsisten. Nikmati diskon spesial untuk pembelian selama periode promo! Bonus gratis ongkir untuk pembelian di atas Rp100.000.","images":["https://i.imgur.com/RP8HTMb.jpeg","https://i.imgur.com/GWXfEGJ.jpeg","https://i.imgur.com/WSB6cXr.jpeg","https://i.imgur.com/ubU63gJ.jpeg"],"specs":[{"label":"Kode Promo","value":"NS-2025-3348"},{"label":"Nama UMKM","value":"nikisae Sae Pempek dan Tahu walik"},{"label":"Pemilik","value":"Yuliana Mulyaningtyas"},{"label":"Alamat","value":"Perum Graha Sultan Raya 1 blok G. 61, Panji"},{"label":"Kontak","value":"085731247566"},{"label":"Media Sosial","value":"Belum tersedia"},{"label":"Daftar Promo","value":"‚Ä¢ Pempek <s>Rp15.000</s> <strong>Rp12.000</strong> (20% OFF)<br>‚Ä¢ Tahu Walik <s>Rp13.750</s> <strong>Rp11.000</strong> (20% OFF)<br>‚Ä¢ Nugget Ikan/Ayam <s>Rp15.000</s> <strong>Rp12.000</strong> (20% OFF)<br>‚Ä¢ Dragon Stick <s>Rp15.000</s> <strong>Rp12.000</strong> (20% OFF)<br>‚Ä¢ Otak-Otak Ikan <s>Rp15.000</s> <strong>Rp12.000</strong> (20% OFF)"},{"label":"Periode Promo","value":"Periode Promo sewaktu-waktu tidak berlaku"},{"label":"Catatan","value":"‚Ä¢ Harga normal berlaku setelah periode promo berakhir<br>‚Ä¢ Minimal pembelian 5 pcs per item<br>‚Ä¢ Free ongkir untuk pembelian di atas Rp100.000 (area tertentu)"}]},"contact":{"whatsapp":"6285731247566","phone":"+6285731247566"}},

{"id":"PRD-2025-2688","category":"fishery","type":"promo","seller":{"name":"PRADIPA","link":"https://www.anekamarket.my.id/pradipa","locationLink":"https://share.google/u64LsJkdOpu18onam"},"badge":{"text":"Promosi","type":"promo"},"mainImage":"https://i.imgur.com/ru1FKXW.jpeg","title":"Produk Hasil Laut Segar Pradipa","code":"PRD-2025-2688","price":30000,"originalPrice":null,"discount":null,"priceVariations":[{"name":"Ikan Bogek/Mendut","price":35000},{"name":"Ikan Mangla/Swangi","price":30000},{"name":"Ikan Sebelah/Sulfis","price":35000}],"units":["kg","ekor","pack"],"defaultUnit":"kg","details":{"description":"<br><b>PRADIPA</b> menghadirkan hasil laut segar langsung dari perairan Panarukan. Kami menyediakan berbagai jenis ikan berkualitas tinggi yang ditangkap dengan metode ramah lingkungan. Setiap produk kami melalui proses seleksi ketat untuk memastikan kesegaran dan kualitas terbaik untuk pelanggan. Dengan pengalaman bertahun-tahun di bidang hasil laut, kami berkomitmen memberikan produk terbaik dengan harga kompetitif.","images":["https://i.imgur.com/n2AkesD.jpeg","https://i.imgur.com/tupfVCl.jpeg","https://i.imgur.com/VhfoAsv.png"],"specs":[{"label":"Kode Produk","value":"PRD-2025-2688"},{"label":"Gerai","value":"PRADIPA"},{"label":"Pemilik","value":"Fajar Nur Cholis"},{"label":"Alamat","value":"Tanah Anyar RT 3 RW 02 Desa Kilensari, Panarukan"},{"label":"Kontak","value":"082334393922 | quenie89@gmail.com"},{"label":"Produk Unggulan","value":"Ikan Bogek/Mendut (Rp35.000/kg), Ikan Mangla/Swangi (Rp30.000/kg), Ikan Sebelah/Sulfis (Rp35.000/kg)"},{"label":"Catatan","value":"Harga bisa berubah sewaktu-waktu"}]},"contact":{"whatsapp":"6282334393922","phone":"+6282334393922"}},

{"id":"MCU-2025-2830","category":"snack","type":"promo","seller":{"name":"Mochi UMA","link":"https://www.anekamarket.my.id/mochiuma","locationLink":"https://maps.app.goo.gl/q8wg1wZA5gVUGgKi6"},"badge":{"text":"Promo Spesial","type":"promo"},"mainImage":"https://i.imgur.com/TPSWsZw.jpeg","title":"Promo Aneka Kue Lezat Mochi Uma","code":"MCU-2025-2830","price":10000,"originalPrice":null,"discount":null,"priceVariations":[{"name":"Pancake Durian","price":10000},{"name":"Mochi (3pcs)","price":10000},{"name":"Cireng Ayam Suwir","price":10000},{"name":"Corndog Coklat (isi 3)","price":10000}],"units":["pcs","pack","set","lusin"],"defaultUnit":"pcs","details":{"description":"<br><strong>PROMO SPESIAL!</strong> Mochi UMA menghadirkan paket promo aneka kue lezat dengan harga spesial. Nikmati berbagai pilihan kue premium dengan diskon menarik untuk waktu terbatas. Setiap produk dibuat dengan bahan pilihan dan teknik khusus untuk menjamin cita rasa autentik. Jangan lewatkan kesempatan ini untuk menikmati kue berkualitas dengan harga terjangkau!","images":["https://i.imgur.com/dlK9kfP.jpeg","https://i.imgur.com/JsXOHCO.jpeg","https://i.imgur.com/kJDDUy4.jpeg"],"specs":[{"label":"Kode Promo","value":"MCU-2025-2830"},{"label":"Nama UMKM","value":"Mochi UMA"},{"label":"Pemilik","value":"ULink"},{"label":"Alamat","value":"Jl. Wijaya Kusuma Samping Bidan Ika"},{"label":"Kontak","value":"089679013099 | nurilaneeh@gmail.com"},{"label":"Media Sosial","value":"TikTok @mochi.uma3"},{"label":"Daftar Promo","value":"‚Ä¢ Pancake Durian hanya Rp10.000<br>‚Ä¢ Mochi 3pcs Rp10.000<br>‚Ä¢ Cireng Ayam Suwir Rp10.000<br>‚Ä¢ Corndog Coklat isi 3 Rp10.000"},{"label":"Periode Promo","value":"Periode dapat berubah sewaktu-waktu"},{"label":"Catatan","value":"Harga bisa berubah sewaktu-waktu"}]},"contact":{"whatsapp":"6289679013099","phone":"+6289679013099"}},

{"id":"UDJ-2025-3038","category":"agriculture","type":"all","seller":{"name":"UD Jaya Makmur","link":"https://anekamarket.my.id/jayamakmur","locationLink":"https://maps.app.goo.gl/9K9YW9tp8ntFTAMo9"},"badge":{"text":"Grosir","type":"rental"},"mainImage":"https://i.imgur.com/fjnwYfW.jpeg","title":"Garam Krosok Geo Membran Premium","code":"UDJ-2025-3038","price":2500,"originalPrice":null,"discount":null,"priceVariations":[{"name":"Per Kilo","price":2500},{"name":"3.5 Ton (Minimal Order) dengan pengiriman ke lokasi","price":8750000}],"units":["kg","ton"],"defaultUnit":"kg","details":{"description":"<br><strong>UD Jaya Makmur</strong> menghadirkan garam krosok geo membran premium berkualitas tinggi dari Panarukan. Garam kami diproduksi dengan metode geo membran yang menghasilkan garam dengan kadar NaCl tinggi (minimal 95%) dan rendah pengotor. Kami menyediakan garam dengan kualitas konsumsi dan industri, dikemas secara higgienie dan siap dikirim ke seluruh Indonesia. Minimal pembelian 3.500 kg dengan layanan pengantaran langsung ke lokasi Anda. Garam kami cocok untuk berbagai kebutuhan mulai dari industri, rumah tangga, hingga pengolahan makanan. ","images":["https://i.imgur.com/WFbAET3.jpeg","https://i.imgur.com/EwIAvxE.jpeg","https://i.imgur.com/5w9ueN7.jpeg"],"specs":[{"label":"Kode Produk","value":"UDJ-2025-3038"},{"label":"Nama UMKM","value":"UD Jaya Makmur"},{"label":"Pemilik","value":"Inunk"},{"label":"Alamat","value":"Kp. Sabrang RT 001 RW 001 Desa Wringin Anom, Panarukan"},{"label":"Jenis Produk","value":"Garam Krosok Geo Membran"},{"label":"Harga","value":"Rp 2.500/kg (minimal 3.500 kg)"},{"label":"Pengiriman","value":"Gratis ongkir untuk area tertentu (minimal 3.5 ton)"},{"label":"Catatan","value":"Harga bisa berubah sewaktu-waktu"}]},"contact":{"whatsapp":"6285338348797","phone":"+6285338348797"}},
    
{"id":"BNJ-2025-3184","category":"food","type":"all","seller":{"name":"Bu Nju","link":"https://anekamarket.my.id/bunju","locationLink":"https://maps.app.goo.gl/sZbdiBAtanBBLGFd9"},"badge":{"text":"Produk Lokal","type":"promo"},"mainImage":"https://i.imgur.com/Ra4CZgd.jpeg","title":"Ikan Kering & Terasi Puger Premium","code":"BNJ-2025-3184","price":4000,"originalPrice":null,"discount":null,"priceVariations":[{"name":"Terasi Puger 1kg","price":80000},{"name":"Terasi Puger 1ons","price":8000},{"name":"Terasi Puger ¬Ωons","price":4000},{"name":"Ikan Kering (berbumbu)","price":75000},{"name":"Ikan Kering (polos)","price":65000}],"units":["pcs","kg","ons","pack"],"defaultUnit":"pcs","details":{"description":"<br><strong>Bu Nju</strong> menghadirkan produk ikan kering dan terasi Puger berkualitas premium dari Panarukan. Terasi kami diproduksi secara tradisional dengan kualitas terbaik, memiliki aroma khas dan rasa gurih autentik. Ikan kering kami diproses secara higienis dengan dua varian: siap goreng (sudah berbumbu) dan polos (tanpa bumbu). Semua produk dibuat dengan bahan pilihan dan pengolahan yang menjaga cita rasa asli. Cocok untuk berbagai masakan rumahan hingga usaha kuliner.","images":["https://i.imgur.com/CV57qDP.jpeg","https://i.imgur.com/ImPrZJw.jpeg","https://i.imgur.com/eFnhNYu.jpeg"],"specs":[{"label":"Kode Produk","value":"BNJ-2025-3184"},{"label":"Nama UMKM","value":"Bu Nju"},{"label":"Pemilik","value":"Riqi"},{"label":"Alamat","value":"Karangsari, Desa Kilensari, Kecamatan Panarukan"},{"label":"Kontak","value":"082327600708"},{"label":"Email","value":"vaiper.blood22@gmail.com"},{"label":"Media Sosial","value":"TikTok @seesaretadek"},{"label":"Catatan","value":"Harga bisa berubah sewaktu-waktu"}]},"contact":{"whatsapp":"6282327600708","phone":"+6282327600708"}},
    
{"id":"LDW-2025-8001","category":"software","type":"promo","seller":{"name":"Lentera Karya Situbondo","link":"https://www.anekamarket.my.id/lenterakaryasitubondo","locationLink":null},"badge":{"text":"Super Deal","type":"promo"},"mainImage":"https://i.imgur.com/VumvfHv.png","title":"Paket Lengkap Aplikasi Web HTML","code":"LDW-2025-8001","price":599000,"originalPrice":899000,"discount":"33% OFF","priceVariations":[{"name":"Paket Komplit (7 Aplikasi)","price":599000},{"name":"Aplikasi Kasir Web","price":350000},{"name":"Sistem Pembukuan Web","price":400000}],"units":["paket","lisensi","unit"],"defaultUnit":"paket","details":{"description":"<br><strong>SOLUSI APLIKASI WEB TERBAIK UNTUK BISNIS ANDA!</strong> Paket lengkap aplikasi web HTML kami dirancang khusus untuk bekerja sempurna di semua perangkat tanpa perlu instalasi. Cukup buka browser dan aplikasi siap digunakan! Setiap aplikasi memiliki anturarmuka modern yang responsif, beradaptasi otomatis dengan layar desktop, tablet, maupun smartphone. Sistem kami mencakup fitur-fitur canggih seperti penyimpanan data di perangkat pengguna, backup/restore, laporan transaksi, dan cetak struk - semuanya dalam platform web yang ringan dan cepat.","images":["https://i.imgur.com/GjByUuX.png","https://i.imgur.com/rsR7RhC.png","https://i.imgur.com/gg5AGFc.png","https://i.imgur.com/VumvfHv.png"],"specs":[{"label":"Kode Produk","value":"LDW-2025-8001"},{"label":"Developer","value":"Lentera Karya Situbondo"},{"label":"Daftar Aplikasi","value":"‚Ä¢ Aplikasi Kasir Web - Sistem kasir lengkap dengan cetak struk<br>‚Ä¢ Sistem Pembukuan Web - Pencatatan keuangan profesional<br>‚Ä¢ Aplikasi Absensi Web - Manajemen kehadiran karyawan<br>‚Ä¢ Sistem Manajemen Restoran - Pesanan, meja, dan kitchen display<br>‚Ä¢ Website Profesional Instan - Website bisnis siap pakai<br>‚Ä¢ Aplikasi Tiket/Karcis - Sistem tiket elektronik<br>‚Ä¢ Sistem Penginapan Web - Manajemen kamar dan tamu"},{"label":"Fitur Unggulan","value":"‚Ä¢ Akses dari perangkat apapun dengan browser modern<br>‚Ä¢ Tampilan responsif otomatis menyesuaikan layar<br>‚Ä¢ Tanpa perlu instalasi - langsung buka file<br>‚Ä¢ Penyimpanan data aman di perangkat pengguna<br>‚Ä¢ Backup & restore data dengan satu klik<br>‚Ä¢ Laporan keuangan lengkap dengan grafik<br>‚Ä¢ Multi-user support dengan level akses berbeda<br>‚Ä¢ Offline capable (PWA) - bisa digunakan tanpa internet"},{"label":"Kompatibilitas","value":"‚Ä¢ Browser: Chrome, Firefox, Edge, Safari versi terbaru<br>‚Ä¢ Sistem Operasi: Windows 10/11, macOS, Linux, Android, iOS<br>‚Ä¢ Perangkat: Desktop, Laptop, Tablet, Smartphone<br>‚Ä¢ Resolusi: Mendukung dari 320px hingga 4K"},{"label":"Cara Penggunaan","value":"1. Terima file HTML via email setelah pembelian<br>2. Buka file di browser favorit Anda (Chrome direkomendasikan)<br>3. Aplikasi siap digunakan segera!<br>4. Simpan sebagai PWA (Add to Home Screen) untuk pengalaman seperti aplikasi native<br>5. Untuk backup, cukup simpan file data yang dihasilkan aplikasi"}]},"contact":{"whatsapp":"6285647709114","phone":"+6285647709114"}}, 

{"id":"LDW-2025-8002","category":"software","type":"promo","seller":{"name":"Lentera Karya Situbondo","link":"https://www.anekamarket.my.id/lenterakaryasitubondo","locationLink":null},"badge":{"text":"Baru!","type":"new"},"mainImage":"https://i.imgur.com/i7PAJfs.png","title":"Aplikasi Kasir Web HTML","code":"LDW-2025-8002","price":350000,"originalPrice":450000,"discount":"22% OFF","priceVariations":[{"name":"Lisensi Tunggal","price":350000}],"units":["lisensi","pcs","unit"],"defaultUnit":"lisensi","details":{"description":"<br><strong>APLIKASI KASIR MODERN TANPA INSTALASI!</strong> Aplikasi Kasir Web HTML dari Lentera Karya Situbondo adalah solusi sempurna untuk bisnis retail, toko, atau usaha kecil. Cukup buka file HTML di browser dan aplikasi siap digunakan! Dirancang khusus untuk bekerja optimal di semua perangkat - dari desktop PC hingga smartphone. Fitur termasuk manajemen produk, transaksi cepat, cetak struk, laporan penjualan, dan penyimpanan data langsung di perangkat Anda. Tidak perlu server mahal atau koneksi internet terus-menerus! Ada bonus voucher diskon 15% juga.","images":["https://i.imgur.com/9IuPANW.png","https://i.imgur.com/PY8ge6k.png","https://i.imgur.com/2Yr4njs.png","https://i.imgur.com/i7PAJfs.png"],"specs":[{"label":"Kode Produk","value":"LDW-2025-8002"},{"label":"Developer","value":"Lentera Karya Situbondo"},{"label":"Fitur Inti","value":"‚Ä¢ Input transaksi cepat dengan anturarmuka modern<br>‚Ä¢ Manajemen produk & kategori<br>‚Ä¢ Pencarian produk instan dengan autocomplete<br>‚Ä¢ Cetak struk pdf dengan header custom<br>‚Ä¢ Laporan harian/mingguan/bulanan dengan grafik<br>‚Ä¢ Backup & restore data dengan enkripsi<br>‚Ä¢ Manajemen diskon dan promo produk<br>‚Ä¢ Hitung kembalian & Stok otomatis berkurang saat transaksi"},{"label":"Keunggulan","value":"‚Ä¢ Buka langsung di browser tanpa proses instalasi<br>‚Ä¢ Tampilan responsif semua device (desktop, tablet, HP)<br>‚Ä¢ Bisa digunakan offline setelah pertama kali dibuka<br>‚Ä¢ Penyimpanan data aman di perangkat pengguna<br>‚Ä¢ Tidak perlu server/hosting yang mahal<br>‚Ä¢ Ringan dan cepat bahkan di spesifikasi rendah<br>‚Ä¢ Update mudah dengan mengganti file HTML<br>‚Ä¢ Tidak ada biaya bulanan/tahunan"},{"label":"Cara Implementasi","value":"1. Dapatkan file HTML aplikasi setelah pembelian<br>2. Buka file di browser favorit (Chrome direkomendasikan)<br>3. Mulai gunakan aplikasi kasir langsung<br>4. (Opsional) Simpan sebagai PWA untuk pengalaman seperti app native<br>5. Data otomatis tersimpan aman di perangkat<br>6. Backup rutin dengan menyimpan file data yang dihasilkan"},{"label":"Bonus Pembelian","value":"‚Ä¢ Panduan penggunaan video step-by-step<br>‚Ä¢ Template struk profesional yang bisa dicustom<br>‚Ä¢ File contoh database produk siap pakai<br>‚Ä¢ Support via WhatsApp¬† gratis<br>‚Ä¢ Voucher diskon 15% untuk pembelian produk lain"}]},"contact":{"whatsapp":"6285647709114","phone":"+6285647709114"}},
 
{"id":"WPU-2025-0610","category":"food","type":"resto","seller":{"name":"Warung Pak Untung","link":"https://anekamarket.my.id/pakuntung","locationLink":"https://maps.app.goo.gl/6xMBrsLe2WmuKRWX9"},"badge":{"text":"Diskon Spesial","type":"promo"},"mainImage":"https://i.imgur.com/1Mvj3cv.jpeg","title":"Menu Bakaran Spesial Warung Pak Untung","code":"WPU-2025-0610","price":30000,"originalPrice":50000,"discount":"40% OFF","priceVariations":[{"name":"Paket Hemat Komplit","price":30000},{"name":"Ikan Super (1 org) - 2 ons","price":25000},{"name":"Ikan Super (1 org) - 3 ons","price":30000},{"name":"Ikan Super (1 org) - 4 ons","price":35000},{"name":"Ikan Super (1 org) - 5 ons","price":45000},{"name":"Ikan Super (1 org) - 6 ons","price":55000},{"name":"Ikan Super (1 org) - 7 ons","price":60000},{"name":"Ikan Super (1 org) - 8 ons","price":70000},{"name":"Ikan Super (1 org) - 9 ons","price":80000},{"name":"Ikan Super (1 org) - 1 kg","price":90000},{"name":"Ikan Super (2 org) - 2 ons","price":30000},{"name":"Ikan Super (2 org) - 3 ons","price":40000},{"name":"Ikan Super (2 org) - 4 ons","price":50000},{"name":"Ikan Super (2 org) - 5 ons","price":60000},{"name":"Ikan Super (2 org) - 6 ons","price":65000},{"name":"Ikan Super (2 org) - 7 ons","price":75000},{"name":"Ikan Super (2 org) - 8 ons","price":85000},{"name":"Ikan Super (2 org) - 9 ons","price":95000},{"name":"Ikan Super (2 org) - 1 kg","price":100000}],"units":["porsi","kg","ons","ekor"],"defaultUnit":"porsi","details":{"description":"<br><strong>Diskon Spesial: Nikmati Sensasi Kuliner Laut Bakar di Warung Pak Untung!</strong><br>Cari tempat makan yang bikin penasaran? Mampir ke <strong>Warung Pak Untung</strong>! Terletak strategis di dekat destinasi Wisata Kampung Kerapu, kami menyajikan hidangan laut bakar segar dengan bumbu rahasia yang meresap sempurna hingga ke dalam daging.<br><br>üî• <strong>PROMO SPESIAL!</strong> Jangan lewatkan paket komplit kami yang super hemat! Cukup dengan <strong>Rp 30.000</strong> saja dari harga normal Rp 50.000, Anda sudah bisa menikmati hidangan lezat yang bikin ketahihan.<br><br>Ingin yang lebih spesial? Pilih sendiri <strong>ikan super segar</strong> kami dengan berbagai ukuran sesuai selera Anda, cocok untuk dinikmati sendiri atau beramai-ramai. Setiap hidangan disajikan dengan sambal khas Pak Untung yang pedasnya nendang dan segar, dijamin akan menyempurnakan setiap suapan Anda.","images":["https://i.imgur.com/54G3vZ8.jpeg","https://i.imgur.com/jSYOe6m.jpeg","https://i.imgur.com/YqGxIMK.jpeg","https://i.imgur.com/2tbgQnd.jpeg","https://i.imgur.com/aSEVqAp.jpeg","https://i.imgur.com/v1kqfUt.jpeg","https://i.imgur.com/8XfYID8.jpeg","https://i.imgur.com/QjUO7gc.jpeg","https://i.imgur.com/NgAvdi7.jpeg","https://i.imgur.com/MOahwIU.jpeg","https://i.imgur.com/vTbwJGv.jpeg"],"specs":[{"label":"Kode Promo","value":"WPU-2025-0610"},{"label":"Nama Gerai","value":"Warung Pak Untung"},{"label":"Pemilik","value":"Mas Eko"},{"label":"Alamat","value":"Jalan Raya Gundil, sebelah barat Wisata Kampung Kerapu (selatan jalan)"},{"label":"Kontak","value":"083826231962"},{"label":"Menu Promo","value":"‚Ä¢ Paket Hemat Komplit <s>Rp50.000</s> <strong>Rp30.000</strong> (Diskon 40%)"},{"label":"Lauk Tambahan","value":"‚Ä¢ Ikan Super (1 Orang) mulai dari Rp25.000<br>‚Ä¢ Ikan Super (2 Orang) mulai dari Rp30.000"},{"label":"Catatan","value":"Harga dapat berubah sewaktu-waktu tanpa pemberitahuan."}]},"contact":{"whatsapp":"6283826231962","phone":"+6283826231962"}},

{"id":"AJN-2025-JASA","category":"construction","type":"jasa","seller":{"name":"Abang Joni","link":"https://anekamarket.my.id/abangjoni","locationLink":"https://www.google.com/maps?q=-7.731845,113.9390115"},"badge":{"text":"Jasa Profesional","type":"service"},"mainImage":"https://i.imgur.com/8SQGdWj.jpeg","title":"Jasa Tukang Profesional Berpengalaman","code":"AJN-2025-JASA","price":0,"originalPrice":null,"discount":"Nego","priceVariations":[],"units":["proyek","harian","borongan"],"defaultUnit":"proyek","details":{"description":"<br><strong>Butuh tukang handal dan berpengalaman untuk proyek bangunan Anda? Abang Joni solusinya!</strong><br><br>Dengan pengalaman sejak tahun 2000, Abang Joni telah terbukti profesional dalam mengerjakan berbagai proyek, mulai dari rumah minimalis, perumahan, kost-kostan, hingga perkantoran. Dikenal dengan karakter yang humoris dan sosial tinggi, Abang Joni tidak hanya memberikan hasil kerja yang rapi dan berkualitas, tetapi juga suasana kerja yang menyenangkan.<br><br>Siap bekerja dengan sistem harian, mingguan, bulanan, maupun borongan sesuai kebutuhan Anda. Hubungi langsung untuk konsultasi gratis dan dapatkan penawaran terbaik untuk proyek impian Anda! Harga bisa nego.","images":["https://i.imgur.com/RzRr0Ei.mp4","https://i.imgur.com/fauf9v5.jpeg","https://i.imgur.com/Vy5WFCg.jpeg","https://i.imgur.com/gVuL79s.jpeg","https://i.imgur.com/lrAPJFa.jpeg","https://i.imgur.com/hIl9fQz.jpeg","https://i.imgur.com/RcQWBKO.jpeg"],"specs":[{"label":"Kode Jasa","value":"AJN-2025-JASA"},{"label":"Nama Tukang","value":"Abang Joni"},{"label":"Pengalaman","value":"Sejak tahun 2000"},{"label":"Portofolio","value":"Rumah minimalis, kolam, gudang, perumahan, kost, perkantoran"},{"label":"Jabatan Proyek","value":"Pernah menjadi Mandor, Kepala Proyek, Kepala Tukang"},{"label":"Sistem Kerja","value":"Harian, Mingguan, Bulanan, Borongan"},{"label":"Karakter","value":"Humoris, Sosial Tinggi, Profesional"},{"label":"Area Layanan","value":"Situbondo & sekitarnya (Nego)"},{"label":"Catatan","value":"Hubungi langsung untuk diskusi harga dan jadwal."}]},"contact":{"whatsapp":"6285257633212","phone":"+6285257633212"}},

{"id":"RIC-2025-0810","category":"snack","type":"promo","seller":{"name":"Regginang Situbondo Ibu Ican","link":"https://anekamarket.my.id/rengginang-situbondo-ibu-ican","locationLink":"https://www.google.com/maps?q=-7.6393021,113.9997534"},"badge":{"text":"Harga Hemat","type":"promo"},"mainImage":"https://i.imgur.com/H3Lc1Qt.jpeg","title":"RENGGINANG ANEKA RASA","code":"RIC-2025-0810","price":18000,"originalPrice":20000,"discount":"10%","priceVariations":[{"name":"Renggginang Rasa Terasi","price":8000},{"name":"Renggginang Rasa Bawang","price":8000},{"name":"Renggginang Rasa Udang","price":8000},{"name":"Renggginang Rasa Cumi","price":8000},{"name":"Renggginang Rasa Mix","price":19000}],"units":["pack 450gram"],"defaultUnit":"pack","details":{"description":"<br><b>Rengginang Gurih Renyah</b> ‚Äì <strong>Cita Rasa Tradisional yang Tak Pernah Lekang oleh Waktu</strong>\n\nNikmati kelezatan rengginang khas Nusantara yang dibuat dari beras ketan pilihan, diproses secara higienis, dan digoreng hingga renyah sempurna. \n\nCocok sebagai camilan keluarga, teman minum teh, atau oleh-oleh khas yang menggugah selera. Tersedia dalam berbagai varian rasa: Terasi,bawang,Udang dan Cumi pasti ketagihan!","images":["https://i.imgur.com/mtQc5pc.jpeg","https://i.imgur.com/EuC9Np2.jpeg","https://i.imgur.com/yGCEh0n.jpeg","https://i.imgur.com/ACGxe8H.jpeg"],"specs":[]},"contact":{"whatsapp":"6282338341476","phone":"+6282338341476"}},                                                                                            
    
{"id":"GPA-2025-4392","category":"food","type":"all","seller":{"name":"PEMPEK AROMARE","link":"https://anekamarket.my.id/aromare","locationLink":"https://www.google.com/maps?q=-7.71544,114.0152576"},"badge":{"text":"Harga Hemat","type":"new"},"mainImage":"https://i.imgur.com/qw8X3pD.jpeg","title":"Pempek Ikan Tenggiri Khas Palembang","code":"GPA-2025-4392","price":17000,"originalPrice":null,"discount":null,"priceVariations":[{"name":"Adaan","price":17000},{"name":"Lenjer","price":17000},{"name":"Kulit","price":17000},{"name":"Kapal Selam Kecil","price":17000}],"units":["Bungkus"],"defaultUnit":"Gram","details":{"description":"<strong>üêü Pempek Aromare ‚Äì Cita Rasa Palembang dalam Satu Kemasan</strong>\n<br>\nNikmati kelezatan autentik khas Palembang dengan Pempek Aromare, sajian pempek ikan tenggiri berkualitas dalam bentuk frozen food praktis. Satu kemasan berisi 4 varian favorit:\n\n<b>- Adaan ‚Äì gurih dan beraroma rempah\n- Lenjer ‚Äì tekstur kenyal yang klasik\n- Kulit ‚Äì rasa khas dengan sentuhan renyah\n- Kapal Selam Mini ‚Äì Gurih Nikmat\n</b>\nüíßDilengkapi dengan pilihan kuah cuko khas Palembang:\n<b>- Pedas üî• ‚Äì untuk pencinta sensasi ekstra\n- Sedang ‚Äì pas di lidah semua kalangan\n- Tidak Pedas ‚Äì tetap tetep nikmat tanpa rasa menyengat</b>\n\n<i>üì¶ Berat bersih: 190 gram</i>\n<b>‚ùÑÔ∏è Cocok untuk stok di freezer, tinggal goreng dan sajikan!</b>\n","images":["https://i.imgur.com/Yx2jg8Y.mp4","https://i.imgur.com/2pw5SOS.jpeg","https://i.imgur.com/yornurz.jpeg","https://i.imgur.com/QDgKZXC.jpeg"],"specs":[{"label":"Pemilik","value":"Sudarwati"},{"label":"Alamat","value":"Jl. Bukit Putih RT.001/RW.003 Kelurahan Ardirejo, Kecamatan panji Kabupaten Situbondo"}]},"contact":{"whatsapp":"6281336314392","phone":"+6281336314392"}},

{"id":"ACL-2025-2410","category":"construction","type":"jasa","seller":{"name":"AUDIO CACA LAS","link":"https://anekamarket.my.id/audiocacalas","locationLink":"https://www.google.com/maps?q=-7.7078922,114.0166565"},"badge":{"text":"Jasa Profesional","type":"service"},"mainImage":"https://i.imgur.com/MRGoHHu.jpeg","title":"JASA LAS DAN SOUND SYSTEM","code":"ACL-2025-2410","price":0,"originalPrice":null,"discount":"Nego","priceVariations":[],"units":["proyek","harian","borongan"],"defaultUnit":"proyek","details":{"description":"<b>üîß Jasa Las & Konstruksi Artistik  </b><strong></strong<br>\n Kami menghadirkan keahlian dalam pembuatan dan pemasangan pagar, kanopi, railing, dan berbagai kebutuhan konstruksi logam lainnya. Gambar di atas menampilkan hasil karya kami berupa pagar dengan desain ukiran laser yang rumit dan elegan‚Äîmenggabungkan kekuatan dan estetika dalam satu bentuk. Cocok untuk memperindah rumah, toko, atau bangunan komersial Anda.<br>\n\n<b>üîä Sewa Sound System untuk Berbagai Acara</b><strong></strong><br>                                         \n Selain jasa las, kami juga menyediakan layanan sewa sound system profesional untuk berbagai acara seperti pernikahan, ulang tahun, seminar, konser kecil, hingga acara komunitas. Peralatan kami berkualitas tinggi, dengan teknisi berpengalaman yang siap memastikan suara jernih dan merata di seluruh area acara.\n<br>\n <b> üéØ Mengapa Memilih Kami?</b>\n- Hasil las rapi dan tahan lama\n- Desain custom sesuai permintaan\n- Sound system berkualitas dengan harga bersahabat\n- Layanan cepat dan profesional\n\nüìû <i>Hubungi kami sekarang untuk konsultasi gratis dan penawaran terbaik!          </i>                                                                            ","images":["https://i.imgur.com/d3YbYNV.jpeg","https://i.imgur.com/gPVdWNB.jpeg","https://i.imgur.com/C6mFdLw.jpeg","https://i.imgur.com/A5Fsyf2.jpeg","https://i.imgur.com/1YpSuKH.jpeg","https://i.imgur.com/DzP9iZl.jpeg","https://i.imgur.com/vDyzdcb.jpeg","https://i.imgur.com/3scBCqU.jpeg","https://i.imgur.com/Joc4BDJ.jpeg","https://i.imgur.com/BgpS4LI.mp4"],"specs":[{"label":"Kode Jasa","value":"ACL-2025-2410"},{"label":"Nama","value":"Moh Hasbullah"},{"label":"Alamat","value":"Jl. Semeru RT.001 RW.011 Kel. Mimbaan Kec. Panji"},{"label":"Sistem Kerja","value":"Harian, Mingguan, Bulanan, Borongan"},{"label":"Area Layanan","value":"Situbondo & sekitarnya (Nego)"},{"label":"Catatan","value":"Hubungi langsung untuk diskusi harga dan jadwal."}]},"contact":{"whatsapp":"6282141424679","phone":"+6282141424679"}}
                                              
];

document.addEventListener('DOMContentLoaded', () => {
    const { jsPDF } = window.jspdf;
    
    // ==============================================
    // --- AWAL PENAMBAHAN FITUR FAVORIT ---
    // ==============================================
    let favorites = JSON.parse(localStorage.getItem('anekamarket-favorites')) || [];
    const galleryGrid = document.getElementById('gallery-grid');
    const body = document.body;

    /**
     * Menyimpan daftar favorit ke localStorage
     */
    function saveFavorites() {
        localStorage.setItem('anekamarket-favorites', JSON.stringify(favorites));
    }

    /**
     * Memeriksa apakah sebuah produk ada di daftar favorit
     * @param {string} productId - ID produk
     * @returns {boolean} - True jika favorit, false jika tidak
     */
    function isFavorite(productId) {
        return favorites.includes(productId.toString());
    }

    /**
     * Menambah/menghapus produk dari favorit dan memperbarui UI
     * @param {string} productId - ID produk
     * @param {HTMLElement} buttonElement - Tombol favorit yang diklik
     */
    function toggleFavorite(productId, buttonElement) {
        playButtonSound();
        const icon = buttonElement.querySelector('i');
        const productCard = buttonElement.closest('.gallery-item');
        const productIdStr = productId.toString(); // Pastikan string
        const index = favorites.indexOf(productIdStr);

        if (index > -1) {
            // Sudah favorit, hapus
            favorites.splice(index, 1);
            buttonElement.classList.remove('active');
            if (icon) icon.className = 'far fa-heart'; // Hati kosong
            if (productCard) productCard.dataset.isFavorite = 'false';
        } else {
            // Belum favorit, tambahkan
            favorites.push(productIdStr);
            buttonElement.classList.add('active');
            if (icon) icon.className = 'fas fa-heart'; // Hati penuh
            if (productCard) productCard.dataset.isFavorite = 'true';
        }
        
        saveFavorites(); // Simpan perubahan

        // Terapkan ulang filter jika filter favorit sedang aktif
        const favoritesFilterBtn = document.querySelector('.product-category-btn[data-category="favorites"]');
        if (favoritesFilterBtn && favoritesFilterBtn.classList.contains('active')) {
            applyFilters();
        }
    }
    // ==============================================
    // --- AKHIR PENAMBAHAN FITUR FAVORIT ---
    // ==============================================

    function injectProductSchema(products) {
        const productSchemaElement = document.getElementById('product-schema');
        if (!productSchemaElement) return;
        const productSchemas = products.map(product => {
            const cleanDescription = (product.details?.description || '').replace(/<[^>]+>/g, ' ').replace(/\s\s+/g, ' ').trim();
            const schema = {
                "@context": "https://schema.org/",
                "@type": "Product",
                "name": product.title,
                "image": product.mainImage,
                "description": cleanDescription,
                "sku": product.id,
                "mpn": product.code,
                "brand": {
                    "@type": "Brand",
                    "name": product.seller?.name || "ANEKAMARKET"
                }
            };
            if (product.price > 0) {
                schema.offers = {
                    "@type": "Offer",
                    "url": `https://anekamarket.my.id/#product-${product.id}`,
                    "priceCurrency": "IDR",
                    "price": product.price,
                    "priceValidUntil": new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                    "availability": "https://schema.org/InStock"
                };
            } else {
                 schema.offers = {
                    "@type": "Offer",
                    "url": `https://anekamarket.my.id/#product-${product.id}`,
                    "priceCurrency": "IDR",
                    "price": "0",
                    "availability": "https://schema.org/Inquire"
                };
            }
            return schema;
        });
        productSchemaElement.textContent = JSON.stringify(productSchemas, null, 2);
    }
    injectProductSchema(products);
    
    function formatPrice(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    }

    async function colorizeQrCode(qrDataUrl, newColor = {r: 0, g: 123, b: 255}) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] < 50 && data[i+1] < 50 && data[i+2] < 50 && data[i+3] > 200) {
                            data[i] = newColor.r; data[i+1] = newColor.g; data[i+2] = newColor.b;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL());
                } catch (error) { resolve(qrDataUrl); }
            };
            img.onerror = (err) => { reject(err); };
            img.crossOrigin = "anonymous";
            img.src = qrDataUrl;
        });
    }
    
    async function generateAndDownloadReceipt(productData, orderDetails) {
        const doc = new jsPDF();
        const transactionId = `TRX-${productData.code}-${Date.now()}`;
        const logoUrl = 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
        
        const toDataURL = url => fetch(url)
            .then(response => response.blob())
            .then(blob => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
        }));

        try {
            const logoBase64 = await toDataURL(logoUrl);
            const pageW = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 0;
            const brandColor = '#007bff'; const darkColor = '#212529';
            const lightColor = '#f8f9fa'; const grayColor = '#6c757d';
            const borderColor = '#dee2e6';

            doc.setFillColor(brandColor);
            doc.rect(0, 0, pageW, 40, 'F');
            doc.addImage(logoBase64, 'PNG', margin, 7.5, 25, 25);
            doc.setFontSize(22).setFont(undefined, 'bold');
            doc.setTextColor('#FFFFFF');
            doc.text('ANEKAMARKET', pageW - margin, 18, { align: 'right' });
            doc.setFontSize(9).setFont(undefined, 'normal');
            doc.text('Jl. PB Sudirman, Wringin Anom, Situbondo', pageW - margin, 24, { align: 'right' });
            doc.text('admin@anekamarket.my.id', pageW - margin, 29, { align: 'right' });
            y = 55;
            
            doc.setFontSize(24).setFont(undefined, 'bold').setTextColor(darkColor);
            const docTitle = orderDetails.type === 'PRE-ORDER' ? 'BUKTI PRE-ORDER' : 'NOTA PEMESANAN';
            doc.text(docTitle, pageW / 2, y, { align: 'center' });
            y += 15;
            
            doc.setFontSize(10).setTextColor(grayColor);
            doc.text('DITERBITKAN UNTUK:', margin, y);
            doc.text('DETAIL TRANSAKSI:', pageW / 2, y);
            doc.setDrawColor(borderColor);
            doc.line(margin, y + 2, pageW - margin, y + 2);
            y += 8;
            
            doc.setFontSize(11).setFont(undefined, 'bold').setTextColor(darkColor);
            doc.text('Pelanggan Anekamarket', margin, y);
            
            const infoLabels = ['ID Transaksi:', 'Tanggal:', 'Gerai Penjual:'];
            const infoValues = [
                transactionId,
                new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
                productData.seller?.name || 'N/A'
            ];

            let transactionDetailsY = y;
            doc.setFontSize(10).setFont(undefined, 'normal');
            for (let i = 0; i < infoLabels.length; i++) {
                doc.setTextColor(grayColor);
                doc.text(infoLabels[i], pageW / 2, transactionDetailsY);
                doc.setTextColor(darkColor);
                doc.text(infoValues[i], pageW - margin, transactionDetailsY, { align: 'right' });
                transactionDetailsY += 7;
            }
            y = transactionDetailsY + 10;

            const tableHeaderY = y;
            doc.setFillColor(darkColor);
            doc.roundedRect(margin, tableHeaderY, pageW - (margin * 2), 10, 2, 2, 'F');
            doc.setFontSize(10).setFont(undefined, 'bold').setTextColor('#FFFFFF');
            doc.text('Deskripsi Produk', margin + 3, tableHeaderY + 7);
            doc.text('Harga Satuan', pageW - margin - 60, tableHeaderY + 7, { align: 'right' });
            doc.text('Jumlah', pageW - margin - 35, tableHeaderY + 7, { align: 'right' });
            doc.text('Subtotal', pageW - margin - 3, tableHeaderY + 7, { align: 'right' });
            
            y += 10;
            doc.setFont(undefined, 'normal').setTextColor(darkColor).setDrawColor(borderColor);
            
            orderDetails.items.forEach((item, index) => {
                const itemY = y;
                if (index % 2 !== 0){ doc.setFillColor(lightColor); doc.rect(margin, itemY, pageW - (margin*2), 10, 'F'); }
                
                const itemDescription = doc.splitTextToSize(`${item.name} (${productData.code})`, 80);
                doc.text(itemDescription, margin + 3, itemY + 7);
                doc.text(formatPrice(item.unitPrice), pageW - margin - 60, itemY + 7, { align: 'right' });
                doc.text(`${item.quantity} ${orderDetails.unit}`, pageW - margin - 35, itemY + 7, { align: 'right' });
                doc.text(formatPrice(item.subtotal), pageW - margin - 3, itemY + 7, { align: 'right' });
                y += 10;
            });
            
            doc.line(margin, y, pageW - margin, y);
            y += 5;

            const totalBoxW = 80;
            const totalBoxX = pageW - margin - totalBoxW;
            
            doc.setFontSize(10).setTextColor(grayColor);
            doc.text('Total Belanja:', totalBoxX, y + 5, { align: 'right' });
            doc.setTextColor(darkColor);
            doc.text(formatPrice(orderDetails.grandTotal), pageW - margin, y + 5, { align: 'right' });

            if (orderDetails.type === 'PRE-ORDER') {
                y += 6;
                doc.setTextColor(grayColor);
                doc.text('Uang Muka (DP):', totalBoxX, y + 5, { align: 'right' });
                doc.setTextColor(darkColor);
                doc.text(orderDetails.dpAmount, pageW - margin, y + 5, { align: 'right' });
                y += 6;
                const sisa = orderDetails.grandTotal - parseFloat(orderDetails.dpAmount.replace(/[^0-9]/g, ''));
                doc.setTextColor(grayColor);
                doc.text('Sisa Pembayaran:', totalBoxX, y + 5, { align: 'right' });
                doc.setTextColor(darkColor);
                doc.text(formatPrice(sisa), pageW - margin, y + 5, { align: 'right' });
            }

            y += 8;
            doc.setLineWidth(0.5).setDrawColor(darkColor);
            doc.line(totalBoxX - 5, y, pageW - margin, y);
            
            y += 2;
            doc.setFillColor(lightColor);
            doc.roundedRect(totalBoxX - 5, y, totalBoxW + 5, 12, 2, 2, 'F');
            doc.setFontSize(12).setFont(undefined, 'bold');
            
            const finalAmount = orderDetails.type === 'PRE-ORDER' ? orderDetails.dpAmount : formatPrice(orderDetails.grandTotal);
            const finalLabel = orderDetails.type === 'PRE-ORDER' ? 'TOTAL DP:' : 'TOTAL BAYAR:';
            doc.text(finalLabel, totalBoxX, y + 8, { align: 'right' });
            doc.setTextColor(brandColor);
            doc.text(finalAmount, pageW - margin, y + 8, { align: 'right' });

            y = doc.internal.pageSize.getHeight() - 40;
            doc.setDrawColor(borderColor);
            doc.line(margin, y, pageW - margin, y);
            y += 8;
            
            doc.setFontSize(8).setFont(undefined, 'italic').setTextColor(grayColor);
            const noteText = doc.splitTextToSize('Struk ini merupakan bukti pemesanan yang sah dan dibuat secara otomatis oleh sistem. Harap simpan struk ini untuk proses konfirmasi pembayaran dengan penjual. Ini BUKAN struk/nota pembelian final yang wajib diterbitkan oleh gerai.', pageW - margin * 2 - 30);
            doc.text(noteText, margin, y);
            
            const qr = qrcode(0, 'M');
            qr.addData('https://s.id/anekamarket');
            qr.make();
            const blackQrCodeImage = qr.createDataURL(4);
            const blueQrCodeImage = await colorizeQrCode(blackQrCodeImage, {r: 0, g: 123, b: 255});
            doc.addImage(blueQrCodeImage, 'PNG', pageW - margin - 22, y, 22, 22);

            y = doc.internal.pageSize.getHeight() - 10;
            doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(grayColor);
            const footerText = `¬© ${new Date().getFullYear()} ANEKAMARKET | Developed by www.anekamarket.my.id`;
            doc.text(footerText, pageW / 2, y, { align: 'center' });

            const safeSellerName = (productData.seller.name || 'Gerai').replace(/[^a-z0-9]/gi, '_');
            doc.save(`Struk-${safeSellerName}-${transactionId}.pdf`);

        } catch (error) { 
            console.error("PDF Generation Error:", error);
            alert("Maaf, terjadi kesalahan saat membuat struk PDF. Silakan coba lagi."); 
        }
    }

    function createProductCardHTML(product) {
         // ==============================================
         // --- PENYESUAIAN FITUR FAVORIT ---
         // ==============================================
         const isFav = isFavorite(product.id); // Cek status favorit
         // ==============================================
         
         const hasPriceVariations = product.priceVariations && product.priceVariations.length > 0;
         
         const priceVariationsHTML = hasPriceVariations 
            ? product.priceVariations.map(v => `
                <div class="price-variation-item" data-price="${v.price || 0}" data-name="${v.name || ''}">
                    <div class="price-variation-info">
                        <span class="price-variation-name">${v.name || ''}</span>
                        <span class="price-variation-value">${formatPrice(v.price)}</span>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" aria-label="Kurangi jumlah">-</button>
                        <input type="number" class="quantity-input" value="0" min="0" aria-label="Jumlah item">
                        <button class="quantity-btn plus" aria-label="Tambah jumlah">+</button>
                    </div>
                </div>`).join('')
            : '';
        
        const units = product.units || [product.defaultUnit || 'pcs'];
        const unitOptionsHTML = units.map(unit => `<option value="${unit}" ${unit === product.defaultUnit ? 'selected' : ''}>${unit}</option>`).join('');
        
        const detailSpecsHTML = (product.details?.specs || []).map(spec => `<div class="spec-item"><span class="spec-label">${spec.label || ''}:</span><span class="spec-value">${spec.value || ''}</span></div>`).join('');
        
        const locationButtonHTML = product.seller?.locationLink
            ? `<a href="${product.seller.locationLink}" target="_blank" class="btn btn-location"><i class="fas fa-map-marker-alt"></i> Lokasi</a>`
            : `<button class="btn btn-location-disabled"><i class="fas fa-map-marker-alt"></i> Lokasi</button>`;

        const whatsappButtonHTML = `<a href="https://wa.me/${product.contact?.whatsapp || ''}?text=Halo%20${encodeURIComponent(product.seller?.name || '')},%20saya%20tertarik%20dengan%20produk%20${encodeURIComponent(product.title || '')}%20(${product.code || ''})" class="btn btn-whatsapp" target="_blank"><i class="fab fa-whatsapp"></i> Chat</a>`;
        const phoneButtonHTML = `<a href="tel:${product.contact?.phone || ''}" class="btn btn-call"><i class="fas fa-phone-alt"></i> Telepon</a>`;
        
        // ==============================================
        // --- PENAMBAHAN TOMBOL FAVORIT ---
        // ==============================================
        const favBtnHTML = `<button class="btn btn-favorite ${isFav ? 'active' : ''}" title="Tandai sebagai Favorit"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button>`;
        // ==============================================

        // ==============================================
        // --- AWAL PERBAIKAN VIDEO (KODE ASLI ANDA, SUDAH BENAR) ---
        // ==============================================
        const allMedia = [product.mainImage, ...(product.details?.images || [])].filter(Boolean);
        
        const imagesHTML = allMedia.map((mediaUrl, index) => {
            const isVideo = mediaUrl.toLowerCase().endsWith('.mp4'); // Cek apakah ini video
            if (isVideo) {
                // Jika video, buat tag <video>
                return `<video 
                            src="${mediaUrl}" 
                            class="gallery-slider-image gallery-slider-video ${index === 0 ? 'active' : ''}" 
                            autoplay 
                            muted 
                            loop 
                            playsinline 
                            controls 
                            preload="metadata" 
                            aria-label="${product.title} - Video ${index + 1}">
                         </video>`;
            } else {
                // Jika bukan video, buat tag <img>
                return `<img 
                            src="${mediaUrl}" 
                            alt="${product.title} - Gambar ${index + 1}" 
                            class="gallery-slider-image gallery-slider-image-file ${index === 0 ? 'active' : ''}" 
                            loading="lazy">`;
            }
        }).join('');
        
        const dotsHTML = allMedia.length > 1 ? `<div class="slider-dots">${allMedia.map((_, index) => `<span class="slider-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`).join('')}</div>` : '';
        // ==============================================
        // --- AKHIR PERBAIKAN VIDEO (KODE ASLI ANDA, SUDAH BENAR) ---
        // ==============================================
        
        // ==============================================
        // --- PENAMBAHAN data-is-favorite ---
        // ==============================================
        return `
            <div class="gallery-item" data-category="${product.category || 'all'}" data-type="${product.type || 'all'}" data-id="${product.id}" id="product-${product.id}" data-is-favorite="${isFav}">
                <a href="${product.seller?.link || '#'}" target="_blank" class="gallery-badge seller">Gerai: ${product.seller?.name || 'N/A'}</a>
                <span class="gallery-badge ${product.badge?.type || 'promo'}">${product.badge?.text || 'Promo'}</span>
                
                <div class="gallery-image-container" data-product-id="${product.id}">
                    ${imagesHTML}
                    ${dotsHTML}
                </div>

                <div class="gallery-details">
                    <h3 class="gallery-title">${product.title || 'Judul Produk'}</h3>
                    <div class="gallery-meta"><span class="gallery-code">Kode: ${product.code || 'N/A'}</span><span class="gallery-seller"><i class="fas fa-store"></i> ${product.seller?.name || 'N/A'}</span></div>
                    <p class="gallery-price">
                        ${product.price > 0 ? `Mulai dari ${formatPrice(product.price)}` : 'Hubungi untuk harga'}
                        ${product.originalPrice ? `<span class="original-price">${formatPrice(product.originalPrice)}</span>` : ''}
                        ${product.discount ? `<span class="discount">${product.discount}</span>` : ''}
                    </p>
                    
                    <div class="price-section-collapsible">
                        <div class="price-variations-container">${priceVariationsHTML}</div>
                        <select class="unit-select">${unitOptionsHTML}</select>
                        <div class="total-price">
                            <span class="total-price-label">Total Harga:</span>
                            <span class="total-price-value">${formatPrice(0)}</span>
                        </div>
                        <div class="gallery-actions" style="margin-top: 15px;">
                             <button class="btn btn-order"><i class="fas fa-shopping-cart"></i> Pesan</button>
                             <button class="btn btn-preorder-toggle"><i class="fas fa-calendar-check"></i> Pre-Order</button>
                        </div>
                        <div class="preorder-form">
                            <div class="preorder-title"><i class="fas fa-money-bill-wave"></i><span>Form Uang Muka (DP)</span></div>
                            <input type="number" class="preorder-input" placeholder="Masukkan nominal DP (minimal 40%)">
                            <p class="preorder-note">* Untuk pre-order, harap masukkan nominal uang muka minimal 40% dari total harga. Kami akan menghubungi Anda untuk konfirmasi lebih lanjut.</p>
                            <button class="btn btn-preorder"><i class="fas fa-paper-plane"></i> Kirim Pre-Order</button>
                        </div>
                    </div>

                    <div class="gallery-detail-expanded">
                        <div class="gallery-content">
                            <p class="gallery-description">${product.details?.description || ''}</p>
                            <div class="gallery-specs">${detailSpecsHTML}</div>
                        </div>
                    </div>
                    
                    <div class="gallery-actions">
                        ${whatsappButtonHTML}
                        ${phoneButtonHTML}
                        <a href="${product.seller?.link || '#'}" target="_blank" class="btn btn-visit"><i class="fas fa-store-alt"></i> Kunjungi Gerai</a>
                        ${locationButtonHTML}
                        ${hasPriceVariations ? '<button class="btn btn-toggle-prices"><i class="fas fa-tags"></i> Cek Harga</button>' : ''}
                        ${favBtnHTML} 
                        <button class="btn btn-detail"><i class="fas fa-chevron-down"></i> Detail</button>
                    </div>
                </div>
            </div>`;
    }

    function renderProducts(productsData) {
        if (!galleryGrid) return;
        galleryGrid.innerHTML = productsData.map(product => createProductCardHTML(product)).join('');
        // Memastikan status favorit UI sudah benar setelah render
        document.querySelectorAll('.gallery-item').forEach(card => {
            const id = card.dataset.id;
            const isFav = isFavorite(id);
            card.dataset.isFavorite = isFav.toString();
            const btn = card.querySelector('.btn-favorite');
            if (btn) {
                btn.classList.toggle('active', isFav);
                const icon = btn.querySelector('i');
                if (icon) icon.className = isFav ? 'fas fa-heart' : 'far fa-heart';
            }
        });
    }
    renderProducts(products); 

    // ==============================================
    // --- AWAL PERBAIKAN SLIDER VIDEO ---
    // ==============================================
     function initializeProductSliders() {
        const containers = document.querySelectorAll('.gallery-image-container');
        containers.forEach(container => {
            const allMedia = container.querySelectorAll('.gallery-slider-image'); // Ambil semua media (img & video)
            const images = container.querySelectorAll('.gallery-slider-image-file'); // Ambil gambar saja
            const videos = container.querySelectorAll('.gallery-slider-video'); // Ambil video saja
            const dots = container.querySelectorAll('.slider-dot');
            let currentIndex = 0;
            let slideInterval;

            if (allMedia.length <= 1) return;

            const showSlide = (index) => {
                allMedia.forEach((m, i) => {
                    m.classList.toggle('active', i === index);
                    // Logika untuk play/pause video saat slide berganti
                    if (m.tagName === 'VIDEO') {
                        if (i === index) {
                            m.play().catch(() => {}); // Coba putar video yang aktif
                        } else {
                            m.pause(); // Pause video yang tidak aktif
                        }
                    }
                });
                dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
            };

            // =================================================================
            // --- INILAH PERBAIKAN YANG DIMINTA (KODE ASLI) ---
            // =================================================================
            const nextSlide = () => {
                // Ambil media yang sedang aktif
                const currentMedium = allMedia[currentIndex];
                
                // Periksa apakah media tersebut adalah VIDEO dan sedang diputar (tidak dijeda)
                if (currentMedium.tagName === 'VIDEO' && !currentMedium.paused) {
                    // Jika ya, JANGAN ganti slide. 
                    // Biarkan video diputar. Interval akan memeriksa lagi 3 detik kemudian.
                    return;
                }

                // Jika media adalah GAMBAR, atau media adalah VIDEO tapi sedang DIJEDA (paused),
                // maka lanjutkan ke slide berikutnya.
                currentIndex = (currentIndex + 1) % allMedia.length;
                showSlide(currentIndex);
            };
            // =================================================================
            // --- AKHIR DARI PERBAIKAN (KODE ASLI) ---
            // =================================================================

            const startSlider = () => {
                stopSlider();
                slideInterval = setInterval(nextSlide, 3000);
                // Coba putar video yang sedang aktif saat slider dimulai
                const currentVideo = container.querySelector('.gallery-slider-video.active');
                if (currentVideo) {
                    currentVideo.play().catch(() => {});
                }
            };

            const stopSlider = () => {
                clearInterval(slideInterval);
                // Pause semua video saat slider di-stop (misal: mouse hover)
                videos.forEach(v => v.pause());
            };
            
            // Tambahkan listener klik untuk zoom HANYA PADA GAMBAR
            images.forEach(img => {
                img.addEventListener('click', () => {
                    document.getElementById('zoomedImage').src = img.src;
                    document.getElementById('imageModal').classList.add('show');
                    body.style.overflow = 'hidden';
                    playButtonSound();
                });
            });

            // Video tidak akan memicu image modal, tapi akan di-pause/play oleh `controls` bawaan

            container.addEventListener('mouseenter', stopSlider);
            container.addEventListener('mouseleave', startSlider);

            startSlider();
        });
    }
    // ==============================================
    // --- AKHIR PERBAIKAN SLIDER VIDEO ---
    // ==============================================
    initializeProductSliders();

    function initCardEventListeners(container) {
         const updateGrandTotal = (productCard) => {
            let grandTotal = 0;
            const variationItems = productCard.querySelectorAll('.price-variation-item');
            variationItems.forEach(item => {
                const price = parseFloat(item.dataset.price) || 0;
                const quantityInput = item.querySelector('.quantity-input');
                const quantity = parseInt(quantityInput.value, 10) || 0;
                grandTotal += price * quantity;
            });
            const totalPriceElement = productCard.querySelector('.total-price-value');
            if (totalPriceElement) {
                totalPriceElement.textContent = formatPrice(grandTotal);
            }
        };

        container.addEventListener('click', async e => {
            const target = e.target;
            const productCard = target.closest('.gallery-item');
            if (!productCard) return;

            // ==============================================
            // --- PENAMBAHAN EVENT LISTENER TOMBOL FAVORIT ---
            // ==============================================
            if (target.closest('.btn-favorite')) {
                const productId = productCard.dataset.id;
                toggleFavorite(productId, target.closest('.btn-favorite'));
            }
            // ==============================================

            if (target.closest('.btn-toggle-prices')) {
                playButtonSound();
                const btn = target.closest('.btn-toggle-prices');
                const priceSection = productCard.querySelector('.price-section-collapsible');
                priceSection.classList.toggle('show');
                btn.classList.toggle('active');
                btn.innerHTML = priceSection.classList.contains('show') 
                    ? '<i class="fas fa-eye-slash"></i> Sembunyikan Harga' 
                    : '<i class="fas fa-tags"></i> Cek Harga';
            }

            // ==============================================
            // LOGIKA TOMBOL DETAIL (ACCORDION) - SUDAH BENAR
            // ==============================================
            if (target.closest('.btn-detail')) {
                playButtonSound();
                const btn = target.closest('.btn-detail');
                const currentCard = target.closest('.gallery-item');
                const expandedContent = currentCard.querySelector('.gallery-detail-expanded');
                const isOpening = !expandedContent.classList.contains('active');

                // Tutup semua detail card yang lain terlebih dahulu
                document.querySelectorAll('.gallery-item').forEach(otherCard => {
                    if (otherCard !== currentCard) {
                        const otherExpandedContent = otherCard.querySelector('.gallery-detail-expanded');
                        const otherBtn = otherCard.querySelector('.btn-detail');
                        if (otherExpandedContent && otherBtn && otherExpandedContent.classList.contains('active')) {
                            otherExpandedContent.classList.remove('active');
                            otherBtn.classList.remove('active');
                            otherBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Detail';
                        }
                    }
                });

                // Buka atau tutup card yang sedang diklik
                if (isOpening) {
                    expandedContent.classList.add('active');
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-chevron-up"></i> Sembunyikan';
                } else {
                    expandedContent.classList.remove('active');
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="fas fa-chevron-down"></i> Detail';
                }
            }
            // ==============================================
            // AKHIR DARI LOGIKA TOMBOL DETAIL
            // ==============================================

            if (target.classList.contains('quantity-btn')) {
                playButtonSound();
                const btn = target;
                const input = btn.parentElement.querySelector('.quantity-input');
                let value = parseInt(input.value, 10) || 0;
                if (btn.classList.contains('plus')) value++;
                else if (btn.classList.contains('minus') && value > 0) value--;
                input.value = value;
                updateGrandTotal(productCard);
            }
            
            if (target.closest('.btn-preorder-toggle')) {
                playButtonSound();
                const btn = target.closest('.btn-preorder-toggle');
                const preorderForm = productCard.querySelector('.preorder-form');
                preorderForm.classList.toggle('active');
                btn.classList.toggle('active');
                btn.innerHTML = preorderForm.classList.contains('active') 
                    ? '<i class="fas fa-times"></i> Batal Pre-Order' 
                    : '<i class="fas fa-calendar-check"></i> Pre-Order';
            }
            
            const productId = productCard.dataset.id;
            const productData = products.find(p => p.id === productId);
            if (!productData) return;

            const gatherOrderDetails = (type = 'PEMESANAN LANGSUNG') => {
                const items = []; let grandTotal = 0;
                const unitSelect = productCard.querySelector('.unit-select');
                const unit = unitSelect ? unitSelect.value : (productData.defaultUnit || 'pcs');
                const variationItems = productCard.querySelectorAll('.price-variation-item');
                variationItems.forEach(item => {
                    const quantity = parseInt(item.querySelector('.quantity-input').value, 10) || 0;
                    if (quantity > 0) {
                        const name = item.dataset.name;
                        const unitPrice = parseFloat(item.dataset.price);
                        const subtotal = unitPrice * quantity;
                        items.push({ name, quantity, unitPrice, subtotal });
                        grandTotal += subtotal;
                    }
                });
                if (items.length === 0) { alert('Anda belum memilih item atau jumlah produk.'); return null; }
                let dpAmount = 'N/A';
                if (type === 'PRE-ORDER') { 
                    const dpInput = productCard.querySelector('.preorder-input'); 
                    const dpValue = parseFloat(dpInput.value); 
                    if (isNaN(dpValue) || dpValue <= 0) { alert('Mohon masukkan nominal DP yang valid'); return null; } 
                    if (dpValue < (grandTotal * 0.4)) { alert(`Uang muka minimal 40% dari total harga (${formatPrice(grandTotal * 0.4)})`); return null; } 
                    dpAmount = formatPrice(dpValue); 
                }
                return { type, items, grandTotal, unit, dpAmount };
            };
            
            const generateWhatsAppMessage = (product, details) => {
                let itemsText = details.items.map(item => `   - ${item.name} (x${item.quantity})`).join('\n');
                let totalText = `Total Harga: *${formatPrice(details.grandTotal)}*`;
                if (details.type === 'PRE-ORDER') totalText += `\nUang Muka: *${details.dpAmount}*`;
                const orderType = details.type === 'PRE-ORDER' ? 'PRE-ORDER' : 'PEMESANAN';
                return `Halo, saya ingin melakukan *${orderType}* untuk produk dari *${product.seller?.name || 'N/A'}*:\n\n*${product.title}*\n${itemsText}\n\nSatuan: ${details.unit}\n${totalText}\n\nBukti pemesanan sudah saya unduh. Mohon info lebih lanjut untuk proses selanjutnya. Terima kasih.`;
            }
            
            const processOrder = async (type) => {
                const orderDetails = gatherOrderDetails(type);
                if (orderDetails) {
                    const confirmationMessage = type === 'PRE-ORDER'
                        ? `Anda akan melakukan Pre-Order dengan total ${formatPrice(orderDetails.grandTotal)} dan DP ${orderDetails.dpAmount}.\n\nSistem akan mengunduh bukti pre-order secara otomatis, lalu mengarahkan Anda ke WhatsApp penjual.\n\nLanjutkan?`
                        : `Anda akan memesan dengan total ${formatPrice(orderDetails.grandTotal)}.\n\nSistem akan mengunduh nota pemesanan secara otomatis, lalu mengarahkan Anda ke WhatsApp penjual.\n\nLanjutkan?`;

                    if (confirm(confirmationMessage)) {
                        playNotificationSound();
                        await generateAndDownloadReceipt(productData, orderDetails);
                        
                        setTimeout(() => {
                          window.open(`https://wa.me/${productData.contact?.whatsapp}?text=${encodeURIComponent(generateWhatsAppMessage(productData, orderDetails))}`, '_blank');
                        }, 500); 
                    }
                }
            };

            if (target.closest('.btn-order')) {
                await processOrder('PEMESANAN LANGSUNG');
            }
            
            if (target.closest('.btn-preorder')) {
                await processOrder('PRE-ORDER');
            }
        });
        
        container.addEventListener('input', e => {
            if (e.target.classList.contains('quantity-input')) {
                if (e.target.value < 0) e.target.value = 0;
                const productCard = e.target.closest('.gallery-item');
                if (productCard) updateGrandTotal(productCard);
            }
        });
    }

    if (galleryGrid) initCardEventListeners(galleryGrid);

    const searchModal = document.getElementById('searchModal'); const searchModalInput = document.getElementById('searchModalInput'); const searchResults = document.getElementById('searchResults'); const headerSearchInput = document.getElementById('headerSearchInput'); const headerSearchBtn = document.getElementById('headerSearchBtn'); const navSearchInput = document.getElementById('navSearchInput'); const navSearchBtn = document.getElementById('navSearchBtn'); const searchFilters = document.getElementById('searchFilters');
    const btnCloseSearchModal = document.querySelector('.btn-close-modal');

    function openSearchModal(query = '') { if (searchModal) { searchModal.classList.add('show'); body.style.overflow = 'hidden'; searchModalInput.value = query; searchModalInput.focus(); performSearch(query); } }
    function closeSearchModal() { if (searchModal) { searchModal.classList.remove('show'); body.style.overflow = ''; } }
    
    function performSearch(query) { 
        const lowerCaseQuery = query.trim().toLowerCase(); 
        
        // ==============================================
        // --- PENYESUAIAN FITUR FAVORIT ---
        // ==============================================
        const filters = {
            discount: document.getElementById('filter-discount')?.checked,
            bonus: document.getElementById('filter-bonus')?.checked,
            negotiable: document.getElementById('filter-negotiable')?.checked,
            sortCheap: document.getElementById('filter-sort-cheap')?.checked,
            favorites: document.getElementById('filter-favorites-modal')?.checked // Ditambahkan
        };
        // ==============================================

        let results = products;
        const isAnyFilterActive = Object.values(filters).some(v => v);

        if (lowerCaseQuery.length >= 2) {
            results = products.filter(p => {
                const descriptionText = (p.details?.description || '').replace(/<[^>]*>?/gm, '');
                const specsText = (p.details?.specs || []).map(s => `${s.label} ${s.value}`).join(' ').replace(/<[^>]*>?/gm, '');
                const searchableText = [p.title, p.seller?.name, p.code, descriptionText, specsText].join(' ').toLowerCase();
                return searchableText.includes(lowerCaseQuery);
            });
        } else if (!isAnyFilterActive) {
            if (searchResults) searchResults.innerHTML = '<p class="search-results-placeholder">Ketik minimal 2 huruf atau pilih filter untuk mencari produk...</p>'; 
            return;
        }
        
        // ==============================================
        // --- PENYESUAIAN FITUR FAVORIT ---
        // ==============================================
        if (filters.favorites) {
            results = results.filter(p => isFavorite(p.id));
        }
        // ==============================================
        
        if (filters.discount) {
            results = results.filter(p => p.originalPrice || p.discount);
        }
        if (filters.bonus) {
            results = results.filter(p => /bonus|gratis|free/i.test(JSON.stringify(p.details)));
        }
        if (filters.negotiable) {
            results = results.filter(p => p.discount === 'Nego' || /nego|estimasi|perkiraan|hubungi/i.test(p.details?.description || ''));
        }

        if (filters.sortCheap) {
            results.sort((a, b) => (a.price || 0) - (b.price || 0));
        }

        displaySearchResults(results); 
    }
    
    function displaySearchResults(results) { if (!searchResults) return; if (results.length === 0) { searchResults.innerHTML = '<p class="search-results-placeholder">Produk tidak ditemukan.</p>'; return; } searchResults.innerHTML = results.map(p => `<a href="#product-${p.id}" class="search-result-item" data-product-id="${p.id}"><img src="${p.mainImage}" alt="${p.title}" class="search-result-image"><div class="search-result-info"><h4>${p.title}</h4><p>oleh ${p.seller?.name || ''} (Kode: ${p.code || ''})</p></div></a>`).join(''); }
    [headerSearchInput, navSearchInput].forEach(input => { if (input) input.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); openSearchModal(input.value); } }); });
    [headerSearchBtn, navSearchBtn].forEach(button => { if (button) button.addEventListener('click', (e) => { e.preventDefault(); const input = button.previousElementSibling; if (input) openSearchModal(input.value); }); });
    if (searchModalInput) searchModalInput.addEventListener('input', () => performSearch(searchModalInput.value));
    if (searchFilters) searchFilters.addEventListener('change', () => performSearch(searchModalInput.value));
    if (btnCloseSearchModal) btnCloseSearchModal.addEventListener('click', closeSearchModal);
    if (searchResults) searchResults.addEventListener('click', (e) => { const link = e.target.closest('.search-result-item'); if (link) { e.preventDefault(); const targetId = link.getAttribute('href'); const targetElement = document.querySelector(targetId); if (targetElement) { closeSearchModal(); setTimeout(() => { window.scrollTo({ top: targetElement.offsetTop - 100, behavior: 'smooth' }); }, 100); } } });
    
    const bgMusic = document.getElementById('bgMusic'); if (bgMusic) { bgMusic.volume = 0.3; let p = false; const pm = () => { if (!p) { bgMusic.play().then(() => { p = true; }).catch(() => {}); } }; pm(); document.body.addEventListener('click', pm, { once: true }); document.body.addEventListener('touchstart', pm, { once: true }); }
    const particlesContainer = document.getElementById('particles'); if (particlesContainer) { for (let i = 0; i < 40; i++) { const pr = document.createElement('div'); pr.classList.add('particle'); const s = Math.random() * 6 + 2; pr.style.width = `${s}px`; pr.style.height = `${s}px`; pr.style.left = `${Math.random() * 100}%`; pr.style.animationDuration = `${Math.random() * 15 + 15}s`; pr.style.animationDelay = `${Math.random() * 10}s`; particlesContainer.appendChild(pr); } }
    const navbar = document.getElementById('navbar'); if (navbar) { window.addEventListener('scroll', () => { const isScrolled = window.scrollY > 50; navbar.classList.toggle('scrolled', isScrolled); }); }
    const mobileMenuToggle = document.getElementById('mobileMenuToggle'); const navLinks = document.getElementById('navLinks'); if (mobileMenuToggle && navLinks) { mobileMenuToggle.addEventListener('click', () => { navLinks.classList.toggle('active'); mobileMenuToggle.innerHTML = navLinks.classList.contains('active') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>'; playButtonSound(); }); navLinks.addEventListener('click', (e) => { if (e.target.tagName === 'A') { navLinks.classList.remove('active'); mobileMenuToggle.innerHTML = '<i class="fas fa-bars"></i>'; } }); }
    const searchToggle = document.getElementById('searchToggle'); const navSearch = document.getElementById('navSearch'); if (searchToggle && navSearch) { searchToggle.addEventListener('click', () => { navSearch.classList.toggle('active'); playButtonSound(); }); }
    
    // ==============================================
    // --- AWAL PERBAIKAN LOGIKA MULTI-FILTER ---
    // ==============================================
    const productCategories = document.querySelector('.product-categories');
    const categoryTabs = document.querySelector('.category-tabs');
    let activeCategories = ['all'];
    let activeTypes = ['all'];

    function applyFilters() {
        document.querySelectorAll('.gallery-item').forEach(item => {
            const iC = item.dataset.category;
            const iT = item.dataset.type;
            const isItemFavorite = item.dataset.isFavorite === 'true';

            // Logika Pencocokan Kategori (cM)
            const cM_all = activeCategories.includes('all');
            const cM_fav = activeCategories.includes('favorites') && isItemFavorite;
            const cM_cat = activeCategories.includes(iC);
            // Tampil jika 'all' aktif, ATAU (filter favorit aktif DAN item adalah favorit), ATAU item cocok dengan kategori lain yang aktif
            const cM = cM_all || cM_fav || cM_cat;

            // Logika Pencocokan Tipe (tM)
            const tM_all = activeTypes.includes('all');
            const tM_type = activeTypes.includes(iT);
            // Logika asli untuk item 'all' agar bisa tampil di filter non-spesifik
            const tM_special = (iT === 'all' && !activeTypes.includes('sewa') && !activeTypes.includes('promo') && !activeTypes.includes('jasa') && !activeTypes.includes('wisata') && !activeTypes.includes('resto') && !activeTypes.includes('cafe') );
            const tM = tM_all || tM_type || tM_special;

            item.style.display = (cM && tM) ? 'flex' : 'none';
        });
    }

    if (productCategories) {
        productCategories.addEventListener('click', e => {
            const btn = e.target.closest('.product-category-btn');
            if (!btn) return;

            playButtonSound();
            const category = btn.dataset.category;
            const allBtn = productCategories.querySelector('.product-category-btn[data-category="all"]');

            if (category === 'all') {
                // Jika 'all' diklik, aktifkan 'all' dan nonaktifkan yang lain
                activeCategories = ['all'];
                productCategories.querySelectorAll('.product-category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            } else {
                // Jika tombol lain diklik, toggle statusnya
                btn.classList.toggle('active');
                // Nonaktifkan 'all'
                if (allBtn) allBtn.classList.remove('active');

                // Bangun ulang array kategori aktif
                activeCategories = [];
                productCategories.querySelectorAll('.product-category-btn.active').forEach(b => {
                    activeCategories.push(b.dataset.category);
                });

                // Jika tidak ada yang aktif, aktifkan 'all'
                if (activeCategories.length === 0) {
                    activeCategories = ['all'];
                    if (allBtn) allBtn.classList.add('active');
                }
            }
            applyFilters();
        });
    }

    if (categoryTabs) {
        categoryTabs.addEventListener('click', e => {
            const btn = e.target.closest('.category-btn');
            if (!btn) return;

            playButtonSound();
            const type = btn.dataset.type;
            const allBtn = categoryTabs.querySelector('.category-btn[data-type="all"]');

            if (type === 'all') {
                // Jika 'all' diklik, aktifkan 'all' dan nonaktifkan yang lain
                activeTypes = ['all'];
                categoryTabs.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            } else {
                // Jika tombol lain diklik, toggle statusnya
                btn.classList.toggle('active');
                // Nonaktifkan 'all'
                if (allBtn) allBtn.classList.remove('active');

                // Bangun ulang array tipe aktif
                activeTypes = [];
                categoryTabs.querySelectorAll('.category-btn.active').forEach(b => {
                    activeTypes.push(b.dataset.type);
                });

                // Jika tidak ada yang aktif, aktifkan 'all'
                if (activeTypes.length === 0) {
                    activeTypes = ['all'];
                    if (allBtn) allBtn.classList.add('active');
                }
            }
            applyFilters();
        });
    }
    // ==============================================
    // --- AKHIR PERBAIKAN LOGIKA MULTI-FILTER ---
    // ==============================================
    
    const contactForm = document.getElementById('contactForm'); if (contactForm) { contactForm.addEventListener('submit', function(e) { /* Biarkan default action dari formsubmit.co berjalan */ }); }
    const orderModal = document.getElementById('orderModal'); const quickOrderBtn = document.getElementById('quick-order'); if (orderModal && quickOrderBtn) { quickOrderBtn.addEventListener('click', () => { orderModal.classList.add('show'); body.style.overflow = 'hidden'; playButtonSound(); }); }
    
    const downloadAppBtn = document.getElementById('downloadAppBtn');
    const downloadModal = document.getElementById('downloadModal');
    if (downloadAppBtn && downloadModal) {
        downloadAppBtn.addEventListener('click', (e) => {
            e.preventDefault();
            downloadModal.classList.add('show');
            body.style.overflow = 'hidden';
            playButtonSound();
        });
    }
    
    document.querySelectorAll('.modal, .image-modal, .search-modal').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal || e.target.classList.contains('close-modal') || e.target.classList.contains('close-image-modal') || e.target.classList.contains('close-search-modal')) { modal.classList.remove('show'); body.style.overflow = ''; } }); });
    
    const notificationSound = document.getElementById('notificationSound');
    const buttonSound = document.getElementById('buttonSound'); 
    
    function playNotificationSound() { if (notificationSound) { notificationSound.currentTime = 0; notificationSound.play().catch(() => {}); } }
    function playButtonSound() { if (buttonSound) { buttonSound.currentTime = 0; buttonSound.play().catch(() => {}); } }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => { anchor.addEventListener('click', function(e) { if (this.getAttribute('href') !== '#' && !this.closest('.search-result-item')) { e.preventDefault(); const target = document.querySelector(this.getAttribute('href')); if (target) { window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' }); } } }); });
    
    const offerNotification = document.getElementById('offerNotification');
    const step1 = document.getElementById('notificationStep1');
    const step2 = document.getElementById('notificationStep2');
    let notificationTimer; 
    const showNotification = () => { if (offerNotification && !localStorage.getItem('offerDismissed')) { offerNotification.classList.add('show'); playNotificationSound(); notificationTimer = setTimeout(hideNotification, 5000); } };
    const hideNotification = () => { if (offerNotification) { offerNotification.classList.remove('show'); localStorage.setItem('offerDismissed', 'true'); clearTimeout(notificationTimer); } };
    setTimeout(showNotification, 5000); 
    if (offerNotification) {
        offerNotification.addEventListener('mouseenter', () => { clearTimeout(notificationTimer); });
        offerNotification.addEventListener('mouseleave', () => { clearTimeout(notificationTimer); notificationTimer = setTimeout(hideNotification, 5000); });
        offerNotification.addEventListener('click', (e) => {
            const target = e.target;
            if (target.id === 'closeNotification' || (target.matches('.notification-btn') && target.dataset.action === 'close')) { hideNotification(); } 
            else if (target.matches('.notification-btn')) {
                clearTimeout(notificationTimer); 
                const action = target.dataset.action;
                if (action === 'next') { step1.classList.remove('active'); step2.classList.add('active'); } 
                else if (action === 'register') { window.open('https://anekamarket.my.id/formulirpendaftaran', '_blank'); hideNotification(); }
            }
        });
    }
    
    let lastScrollTop = 0;
    const fabContainers = document.querySelectorAll('.autohide-fab');
    window.addEventListener('scroll', function() {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop && scrollTop > 200) { fabContainers.forEach(container => container.classList.add('fab-hidden')); } 
        else { fabContainers.forEach(container => container.classList.remove('fab-hidden')); }
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }, false);

    const generatorModal = document.getElementById('generatorModal'); const openGeneratorBtn = document.getElementById('openGeneratorBtn'); const closeGeneratorModalBtn = document.getElementById('closeGeneratorModal'); const generatorForm = document.getElementById('productGeneratorForm'); const priceVariationsContainer = document.getElementById('priceVariationsContainer'); const specsContainer = document.getElementById('specsContainer'); const addPriceVariationBtn = document.getElementById('addPriceVariationBtn'); const addSpecBtn = document.getElementById('addSpecBtn'); const outputContainer = document.getElementById('generatorOutputContainer'); const outputElement = document.getElementById('generatedScriptOutput'); const outputWrapper = document.getElementById('generatedScriptWrapper'); const copyScriptBtn = document.getElementById('copyScriptBtn'); const downloadScriptBtn = document.getElementById('downloadScriptBtn'); const toggleVisibilityBtn = document.getElementById('toggleScriptVisibilityBtn'); const importScriptBtn = document.getElementById('importScriptBtn'); const genImporter = document.getElementById('gen-importer'); const previewProductBtn = document.getElementById('previewProductBtn'); const generatorPreviewContainer = document.getElementById('generatorPreviewContainer'); const previewTarget = document.getElementById('previewTarget');
    const openGeneratorModal = () => { if (generatorModal) { generatorModal.classList.add('show'); body.style.overflow = 'hidden'; }};
    const closeGeneratorModal = () => { if (generatorModal) { generatorModal.classList.remove('show'); body.style.overflow = ''; }};
    if (openGeneratorBtn) { openGeneratorBtn.addEventListener('click', () => { playButtonSound(); const password = prompt("Masukkan password untuk mengakses generator:"); if (password === "LKS.1945") { openGeneratorModal(); } else if (password !== null) { alert("Password salah. Akses ditolak."); } }); }
    if (closeGeneratorModalBtn) closeGeneratorModalBtn.addEventListener('click', closeGeneratorModal);
    if (generatorModal) generatorModal.addEventListener('click', (e) => { if (e.target === generatorModal) closeGeneratorModal(); });
    const addDynamicItem = (container, name = '', value = '', placeholder1, placeholder2) => {
        const item = document.createElement('div'); item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="text" class="dynamic-name" placeholder="${placeholder1}" value="${name}" required> <input type="text" class="dynamic-value" placeholder="${placeholder2}" value="${value}" required> <button type="button" class="btn-remove-item"><i class="fas fa-trash"></i></button>`;
        if (container === priceVariationsContainer) { item.querySelector('.dynamic-value').type = 'number'; }
        container.appendChild(item); item.querySelector('.btn-remove-item').addEventListener('click', () => item.remove());
    };
    if (addPriceVariationBtn) addPriceVariationBtn.addEventListener('click', () => addDynamicItem(priceVariationsContainer, '', '', 'Nama Variasi (e.g., Ecer)', 'Harga (e.g., 8000)'));
    if (addSpecBtn) addSpecBtn.addEventListener('click', () => addDynamicItem(specsContainer, '', '', 'Label (e.g., Kode Produk)', 'Value (e.g., ACA-2025-8899)'));
    function getProductDataFromForm() {
        const product = {}; product.id = document.getElementById('gen-id').value; product.category = document.getElementById('gen-category').value; product.type = document.getElementById('gen-type').value;
        product.seller = { name: document.getElementById('gen-seller-name').value, link: document.getElementById('gen-seller-link').value, locationLink: document.getElementById('gen-seller-location').value || null };
        product.badge = { text: document.getElementById('gen-badge-text').value, type: document.getElementById('gen-badge-type').value }; product.mainImage = document.getElementById('gen-mainImage').value; product.title = document.getElementById('gen-title').value; product.code = document.getElementById('gen-code').value; product.price = parseFloat(document.getElementById('gen-price').value) || 0;
        const originalPrice = document.getElementById('gen-originalPrice').value; product.originalPrice = originalPrice ? parseFloat(originalPrice) : null; const discount = document.getElementById('gen-discount').value; product.discount = discount || null;
        product.priceVariations = []; priceVariationsContainer.querySelectorAll('.dynamic-list-item').forEach(item => { const name = item.querySelector('.dynamic-name').value; const price = parseFloat(item.querySelector('.dynamic-value').value); if (name && !isNaN(price)) product.priceVariations.push({ name, price }); });
        product.units = document.getElementById('gen-units').value.split(',').map(u => u.trim()).filter(u => u); product.defaultUnit = document.getElementById('gen-defaultUnit').value;
        product.details = { description: document.getElementById('gen-description').value, images: document.getElementById('gen-images').value.split(/[\n,]+/).map(img => img.trim()).filter(img => img), specs: [] };
        specsContainer.querySelectorAll('.dynamic-list-item').forEach(item => { const label = item.querySelector('.dynamic-name').value; const value = item.querySelector('.dynamic-value').value; if (label && value) product.details.specs.push({ label, value }); });
        product.contact = { whatsapp: document.getElementById('gen-contact-whatsapp').value, phone: document.getElementById('gen-contact-phone').value };
        return product;
    }
    if (generatorForm) { generatorForm.addEventListener('submit', (e) => { e.preventDefault(); const product = getProductDataFromForm(); const jsonString = JSON.stringify(product); outputElement.textContent = jsonString; outputContainer.style.display = 'block'; generatorPreviewContainer.style.display = 'none'; outputContainer.scrollIntoView({ behavior: 'smooth' }); playButtonSound(); }); }
    if (importScriptBtn) {
        importScriptBtn.addEventListener('click', () => {
            let scriptText = genImporter.value.trim(); if (!scriptText) { alert("Area teks kosong. Silakan tempel script produk."); return; }
            try {
                if (!scriptText.startsWith('{') && !scriptText.startsWith('[')) { const jsonStart = scriptText.indexOf('{'); const jsonStartArray = scriptText.indexOf('['); let startIndex = -1; if (jsonStart !== -1 && jsonStartArray !== -1) { startIndex = Math.min(jsonStart, jsonStartArray); } else if (jsonStart !== -1) { startIndex = jsonStart; } else { startIndex = jsonStartArray; } if (startIndex !== -1) { scriptText = scriptText.substring(startIndex); } }
                scriptText = scriptText.replace(/,\s*([}\]])/g, "$1"); let rawData = JSON.parse(scriptText); let productData;
                if (Array.isArray(rawData)) { if (rawData.length > 0) { productData = rawData[0]; alert('Dideteksi input berupa array. Data dari produk pertama dalam daftar telah dimuat.'); } else { alert('Array yang Anda tempel kosong. Tidak ada data untuk dimuat.'); return; } } else { productData = rawData; }
                if (typeof productData !== 'object' || productData === null) { throw new Error("Data yang valid tidak ditemukan."); }
                document.getElementById('gen-id').value = productData.id || ''; document.getElementById('gen-code').value = productData.code || productData.id || ''; document.getElementById('gen-title').value = productData.title || ''; document.getElementById('gen-category').value = productData.category || 'food'; document.getElementById('gen-type').value = productData.type || 'all'; document.getElementById('gen-mainImage').value = productData.mainImage || ''; document.getElementById('gen-price').value = productData.price ?? ''; document.getElementById('gen-originalPrice').value = productData.originalPrice ?? ''; document.getElementById('gen-discount').value = productData.discount || ''; document.getElementById('gen-badge-text').value = productData.badge?.text || ''; document.getElementById('gen-badge-type').value = productData.badge?.type || 'promo'; document.getElementById('gen-seller-name').value = productData.seller?.name || ''; document.getElementById('gen-seller-link').value = productData.seller?.link || ''; document.getElementById('gen-seller-location').value = productData.seller?.locationLink || ''; document.getElementById('gen-contact-whatsapp').value = productData.contact?.whatsapp || ''; document.getElementById('gen-contact-phone').value = productData.contact?.phone || ''; document.getElementById('gen-units').value = productData.units?.join(', ') || ''; document.getElementById('gen-defaultUnit').value = productData.defaultUnit || ''; document.getElementById('gen-description').value = productData.details?.description || ''; document.getElementById('gen-images').value = productData.details?.images?.join(',\n') || '';
                priceVariationsContainer.innerHTML = ''; (productData.priceVariations || []).forEach(v => addDynamicItem(priceVariationsContainer, v.name, v.price, 'Nama Variasi', 'Harga'));
                specsContainer.innerHTML = ''; (productData.details?.specs || []).forEach(s => addDynamicItem(specsContainer, s.label, s.value, 'Label', 'Value'));
                alert('Data produk berhasil dimuat ke dalam form!'); playButtonSound();
            } catch (error) { alert(`Gagal memuat data. Pastikan script JSON valid.\n\nDetail: ${error.message}`); console.error('JSON Parse Error:', error); }
        });
    }
    if (previewProductBtn) { previewProductBtn.addEventListener('click', () => { try { const productData = getProductDataFromForm(); previewTarget.innerHTML = createProductCardHTML(productData); generatorPreviewContainer.style.display = 'block'; outputContainer.style.display = 'none'; initCardEventListeners(previewTarget); initializeProductSliders(); generatorPreviewContainer.scrollIntoView({ behavior: 'smooth' }); playButtonSound(); } catch(e){ alert("Gagal membuat preview. Pastikan semua field wajib diisi dengan benar."); } }); }
    if (copyScriptBtn) copyScriptBtn.addEventListener('click', () => { navigator.clipboard.writeText(outputElement.textContent).then(() => alert('Script berhasil disalin!')).catch(err => alert('Gagal menyalin.')); playButtonSound(); });
    if (downloadScriptBtn) downloadScriptBtn.addEventListener('click', () => { const blob = new Blob([outputElement.textContent], { type: 'application/javascript' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const fileName = document.getElementById('gen-id').value || 'product-data'; a.href = url; a.download = `${fileName}.js`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); playButtonSound(); });
    if (toggleVisibilityBtn) toggleVisibilityBtn.addEventListener('click', () => { outputWrapper.classList.toggle('visible'); const icon = toggleVisibilityBtn.querySelector('i'); if (icon) icon.className = outputWrapper.classList.contains('visible') ? 'fas fa-eye' : 'fas fa-eye-slash'; playButtonSound(); });
    const whatsappInput = document.getElementById('gen-contact-whatsapp'); const phoneInput = document.getElementById('gen-contact-phone');
    if (whatsappInput) { whatsappInput.addEventListener('input', (e) => { let value = e.target.value.replace(/\D/g, ''); if (value.startsWith('0')) { value = '62' + value.substring(1); } else if (value.startsWith('+62')) { value = '62' + value.substring(3); } e.target.value = value; }); }
    if (phoneInput) { phoneInput.addEventListener('input', (e) => { let value = e.target.value.replace(/[^0-9+]/g, ''); if (value.startsWith('0')) { value = '+62' + value.substring(1); } else if (!value.startsWith('+')) { value = '+' + value; } e.target.value = value; }); }
    const descriptionTextarea = document.getElementById('gen-description'); const toolbar = document.querySelector('.description-toolbar');
    if (toolbar && descriptionTextarea) {
        toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('.toolbar-btn'); if (!button) return;
            const tag = button.dataset.tag; const start = descriptionTextarea.selectionStart; const end = descriptionTextarea.selectionEnd; const selectedText = descriptionTextarea.value.substring(start, end); const beforeText = descriptionTextarea.value.substring(0, start); const afterText = descriptionTextarea.value.substring(end);
            let replacement; let cursorPosition = start;
            if (tag === 'br') { replacement = '<br>'; descriptionTextarea.value = beforeText + replacement + afterText; cursorPosition += replacement.length; } 
            else { replacement = `<${tag}>${selectedText}</${tag}>`; descriptionTextarea.value = beforeText + replacement + afterText; cursorPosition = start + replacement.length; }
            descriptionTextarea.focus(); descriptionTextarea.selectionStart = descriptionTextarea.selectionEnd = cursorPosition;
        });
    }
});
